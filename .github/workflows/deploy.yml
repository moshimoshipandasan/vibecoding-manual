name: Build and Deploy to GitHub Pages

on:
  push:
    branches:
      - main  # main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

permissions:
  contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Source Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Rubyç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true  # Gemfileã®ä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥

      # Jekyllä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Dependencies
        run: |
          gem install bundler
          bundle install

      # Jekyllã§ã‚µã‚¤ãƒˆã‚’ãƒ“ãƒ«ãƒ‰
      - name: Build Jekyll Site
        run: |
          bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      # ãƒ“ãƒ«ãƒ‰ã—ãŸã‚µã‚¤ãƒˆã‚’åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy to GitHub Pages Repository
        env:
          TARGET_REPO: ${{ github.repository }}-site  # è‡ªå‹•çš„ã« -site ã‚’ä»˜ã‘ãŸãƒªãƒã‚¸ãƒˆãƒªå
          TARGET_BRANCH: main
          BUILD_DIR: ./_site
          GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }}  # Personal Access Token
        run: |
          # Gitã®è¨­å®š
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
          cd $BUILD_DIR

          # æ–°ã—ã„Gitãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦åˆæœŸåŒ–
          git init

          # .nojekyll ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆJekyllå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          touch .nojekyll

          # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add .

          # ã‚³ãƒŸãƒƒãƒˆ
          git commit -m "Deploy from source repository: ${{ github.sha }}"

          # ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’è¨­å®šã—ã¦ãƒ—ãƒƒã‚·ãƒ¥
          git remote add origin https://x-access-token:${GITHUB_TOKEN}@github.com/${TARGET_REPO}.git

          # å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆå±¥æ­´ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã«ä¿ã¤ï¼‰
          git push -f origin HEAD:${TARGET_BRANCH}

      # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
      - name: Deployment Status
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸŒ Your site will be available at: https://${{ github.repository_owner }}.github.io/$(basename ${{ github.repository }}-site)/"

      # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥
      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed. Please check the logs."